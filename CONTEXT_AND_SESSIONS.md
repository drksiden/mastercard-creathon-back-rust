# üí¨ –ö–æ–Ω—Ç–µ–∫—Å—Ç –∏ —Å–µ—Å—Å–∏–∏

## –¢–µ–∫—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ

**–°–µ–π—á–∞—Å:** –ö–∞–∂–¥—ã–π –∑–∞–ø—Ä–æ—Å –Ω–µ–∑–∞–≤–∏—Å–∏–º—ã–π, –∫–æ–Ω—Ç–µ–∫—Å—Ç –Ω–µ —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è.

**–ù–æ:** `rig-core` —É–∂–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç `chat_history` –≤ `CompletionRequest`!

## üéØ –ö–∞–∫ —ç—Ç–æ –º–æ–∂–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å

### –í–∞—Ä–∏–∞–Ω—Ç 1: –ò—Å—Ç–æ—Ä–∏—è –Ω–∞ —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥–µ/–±–æ—Ç–µ

–•—Ä–∞–Ω–∏—Ç–µ –∏—Å—Ç–æ—Ä–∏—é –Ω–∞ –∫–ª–∏–µ–Ω—Ç–µ –∏ –æ—Ç–ø—Ä–∞–≤–ª—è–π—Ç–µ —Å –∫–∞–∂–¥—ã–º –∑–∞–ø—Ä–æ—Å–æ–º:

```typescript
// –ù–∞ —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥–µ
const history = [
  { role: "user", content: "–°–∫–æ–ª—å–∫–æ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π —Å–µ–≥–æ–¥–Ω—è?" },
  { role: "assistant", content: "–°–µ–≥–æ–¥–Ω—è –±—ã–ª–æ 1523 —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏" },
  { role: "user", content: "–ê –≤—á–µ—Ä–∞?" }  // –ú–æ–¥–µ–ª—å –ø–æ–Ω–∏–º–∞–µ—Ç –∫–æ–Ω—Ç–µ–∫—Å—Ç!
];
```

### –í–∞—Ä–∏–∞–Ω—Ç 2: –°–µ—Å—Å–∏–∏ –Ω–∞ –±—ç–∫–µ–Ω–¥–µ (TODO)

–ú–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –ø–æ–¥–¥–µ—Ä–∂–∫—É —Å–µ—Å—Å–∏–π:

```rust
// –ë—É–¥—É—â–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞
pub struct Session {
    pub session_id: String,
    pub user_id: String,
    pub chat_history: Vec<Message>,
    pub created_at: DateTime<Utc>,
}
```

## üîß –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ chat_history –≤ rig-core

`rig-core` —É–∂–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç –∏—Å—Ç–æ—Ä–∏—é —á–µ—Ä–µ–∑ `chat_history`:

```rust
let request = CompletionRequest {
    preamble: Some("...".to_string()),
    chat_history: OneOrMany::many(vec![
        Message::User {
            content: OneOrMany::one(UserContent::text("–°–∫–æ–ª—å–∫–æ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π?")),
        },
        Message::Assistant {
            content: OneOrMany::one(AssistantContent::Text(Text {
                text: "1523 —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏".to_string(),
            })),
        },
        Message::User {
            content: OneOrMany::one(UserContent::text("–ê –≤—á–µ—Ä–∞?")),
        },
    ]),
    // ...
};
```

## üìù –ü—Ä–∏–º–µ—Ä—ã –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞

### –ü—Ä–∏–º–µ—Ä 1: –ü–æ—Å–ª–µ–¥—É—é—â–∏–µ –≤–æ–ø—Ä–æ—Å—ã

```
–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: "–°–∫–æ–ª—å–∫–æ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π —Å–µ–≥–æ–¥–Ω—è?"
–ë–æ—Ç: "1523 —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏"

–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: "–ê –≤—á–µ—Ä–∞?"  // –ü–æ–Ω–∏–º–∞–µ—Ç –∫–æ–Ω—Ç–µ–∫—Å—Ç!
–ë–æ—Ç: "–í—á–µ—Ä–∞ –±—ã–ª–æ 1456 —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π"
```

### –ü—Ä–∏–º–µ—Ä 2: –£—Ç–æ—á–Ω–µ–Ω–∏—è

```
–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: "–¢–æ–ø-5 –∫–∞—Ç–µ–≥–æ—Ä–∏–π MCC"
–ë–æ—Ç: [–ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç —Ç–æ–ø-5]

–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: "–ü–æ–∫–∞–∂–∏ –¥–µ—Ç–∞–ª–∏ –ø–æ –ø–µ—Ä–≤–æ–π"  // –ü–æ–Ω–∏–º–∞–µ—Ç "–ø–µ—Ä–≤–∞—è" = –ø–µ—Ä–≤–∞—è –∫–∞—Ç–µ–≥–æ—Ä–∏—è
–ë–æ—Ç: [–ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç –¥–µ—Ç–∞–ª–∏ –ø–æ Dining & Restaurants]
```

## üöÄ –†–µ–∞–ª–∏–∑–∞—Ü–∏—è —Å–µ—Å—Å–∏–π (–±—É–¥—É—â–µ–µ)

### API —Å —Å–µ—Å—Å–∏—è–º–∏

```json
POST /api/query
{
  "question": "–°–∫–æ–ª—å–∫–æ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π?",
  "session_id": "user-123-session-456",  // –û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ
  "include_analysis": true
}
```

### –•—Ä–∞–Ω–µ–Ω–∏–µ —Å–µ—Å—Å–∏–π

```rust
// –í –ø–∞–º—è—Ç–∏ (–¥–ª—è –Ω–∞—á–∞–ª–∞)
use std::collections::HashMap;
use tokio::sync::RwLock;

pub struct SessionManager {
    sessions: Arc<RwLock<HashMap<String, Session>>>,
}

struct Session {
    session_id: String,
    history: Vec<Message>,
    last_activity: Instant,
}
```

## üí° –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏

### –î–ª—è –Ω–∞—á–∞–ª–∞:

1. **–•—Ä–∞–Ω–∏—Ç–µ –∏—Å—Ç–æ—Ä–∏—é –Ω–∞ –∫–ª–∏–µ–Ω—Ç–µ** (—Ñ—Ä–æ–Ω—Ç–µ–Ω–¥/–±–æ—Ç)
2. **–û—Ç–ø—Ä–∞–≤–ª—è–π—Ç–µ –ø–æ—Å–ª–µ–¥–Ω–∏–µ N —Å–æ–æ–±—â–µ–Ω–∏–π** —Å –∫–∞–∂–¥—ã–º –∑–∞–ø—Ä–æ—Å–æ–º
3. **–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∫—ç—à** –¥–ª—è –ø–æ–≤—Ç–æ—Ä—è—é—â–∏—Ö—Å—è –∑–∞–ø—Ä–æ—Å–æ–≤

### –î–ª—è production:

1. **–î–æ–±–∞–≤—å—Ç–µ —Å–µ—Å—Å–∏–∏ –Ω–∞ –±—ç–∫–µ–Ω–¥–µ**
2. **–•—Ä–∞–Ω–∏—Ç–µ –≤ Redis** (–¥–ª—è –º–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏—è)
3. **TTL –¥–ª—è —Å–µ—Å—Å–∏–π** (–Ω–∞–ø—Ä–∏–º–µ—Ä, 1 —á–∞—Å –Ω–µ–∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏)
4. **–û–≥—Ä–∞–Ω–∏—á—å—Ç–µ —Ä–∞–∑–º–µ—Ä –∏—Å—Ç–æ—Ä–∏–∏** (–ø–æ—Å–ª–µ–¥–Ω–∏–µ 10-20 —Å–æ–æ–±—â–µ–Ω–∏–π)

## üîÑ –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å Ollama CLI –∫–æ–º–∞–Ω–¥–∞–º–∏

–ö–æ–º–∞–Ω–¥—ã Ollama CLI (`/set`, `/save`, `/load`) —Ä–∞–±–æ—Ç–∞—é—Ç –≤ –∏–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω–æ–º —Ä–µ–∂–∏–º–µ.

–í –Ω–∞—à–µ–π —Å–∏—Å—Ç–µ–º–µ —á–µ—Ä–µ–∑ `rig-core`:
- ‚úÖ **–ò—Å—Ç–æ—Ä–∏—è** - —á–µ—Ä–µ–∑ `chat_history` –≤ `CompletionRequest`
- ‚úÖ **–ö–æ–Ω—Ç–µ–∫—Å—Ç** - –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è –≤ –∏—Å—Ç–æ—Ä–∏–∏
- ‚ö†Ô∏è **–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —Å–µ—Å—Å–∏–π** - –Ω—É–∂–Ω–æ —Ä–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å –æ—Ç–¥–µ–ª—å–Ω–æ

## üìä –ü—Ä–∏–º–µ—Ä –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è

### –° –∏—Å—Ç–æ—Ä–∏–µ–π (–±—É–¥—É—â–µ–µ)

```rust
// –í LLMClient
pub async fn generate_sql_with_history(
    &self,
    question: &str,
    history: &[Message],  // –ò—Å—Ç–æ—Ä–∏—è –ø—Ä–µ–¥—ã–¥—É—â–∏—Ö —Å–æ–æ–±—â–µ–Ω–∏–π
) -> Result<String> {
    let prompt = super::prompts::build_sql_generation_prompt(question);
    
    // –î–æ–±–∞–≤–ª—è–µ–º –∏—Å—Ç–æ—Ä–∏—é –∫ –∑–∞–ø—Ä–æ—Å—É
    let mut chat_history = history.to_vec();
    chat_history.push(Message::User {
        content: OneOrMany::one(UserContent::text(prompt)),
    });
    
    let request = CompletionRequest {
        chat_history: OneOrMany::many(chat_history),
        // ...
    };
    
    // ... –æ—Å—Ç–∞–ª—å–Ω–æ–π –∫–æ–¥
}
```

## ‚úÖ –ò—Ç–æ–≥

- ‚úÖ `rig-core` –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç `chat_history`
- ‚úÖ –ú–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å —Å–µ—Å—Å–∏–∏ –Ω–∞ –±—ç–∫–µ–Ω–¥–µ
- ‚úÖ –î–ª—è –Ω–∞—á–∞–ª–∞ - —Ö—Ä–∞–Ω–∏—Ç–µ –∏—Å—Ç–æ—Ä–∏—é –Ω–∞ –∫–ª–∏–µ–Ω—Ç–µ
- ‚úÖ –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∫—ç—à –¥–ª—è –ø–æ–≤—Ç–æ—Ä—è—é—â–∏—Ö—Å—è –∑–∞–ø—Ä–æ—Å–æ–≤

**–°–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏:**
1. –î–æ–±–∞–≤–∏—Ç—å –ø–æ–ª–µ `session_id` –≤ `QueryRequest`
2. –°–æ–∑–¥–∞—Ç—å `SessionManager` –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è —Å–µ—Å—Å–∏–π
3. –ü–µ—Ä–µ–¥–∞–≤–∞—Ç—å –∏—Å—Ç–æ—Ä–∏—é –≤ `chat_history` –ø—Ä–∏ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ SQL

